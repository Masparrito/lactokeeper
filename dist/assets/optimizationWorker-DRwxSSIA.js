(function(){"use strict";const Et=(t,r)=>{const e={initialCabras:t.initialCabras??0,initialLevanteTardio:t.initialLevanteTardio??0,initialLevanteMedio:t.initialLevanteMedio??0,initialLevanteTemprano:t.initialLevanteTemprano??0,initialCriaH:t.initialCriaH??0,initialCriaM:t.initialCriaM??0,initialPadres:t.initialPadres??1,comprasVientresAnual:t.comprasVientresAnual??0,mesInicioMonta1:t.mesInicioMonta1,mesInicioMonta2:t.mesInicioMonta2,mesInicioMonta3:t.mesInicioMonta3,mesInicioMonta4:t.mesInicioMonta4,duracionMontaDias:t.duracionMontaDias??45,diasGestacion:t.diasGestacion??150,litrosPromedioPorAnimal:t.litrosPromedioPorAnimal??1.8,diasLactanciaObjetivo:t.diasLactanciaObjetivo??305,litrosPicoPorAnimal:t.litrosPicoPorAnimal??((t.diasLactanciaObjetivo??305)>=305?(t.litrosPromedioPorAnimal??1.8)*1.4:(t.litrosPromedioPorAnimal??1.8)*1.5),porcentajePrenez:t.porcentajePrenez??85,porcentajeProlificidad:t.porcentajeProlificidad??120,mortalidadCrias:t.mortalidadCrias??5,mortalidadLevante:t.mortalidadLevante??3,mortalidadCabras:t.mortalidadCabras??3,tasaReemplazo:t.tasaReemplazo??20,eliminacionCabritos:t.eliminacionCabritos??100,precioLecheLitro:t.precioLecheLitro??.5,precioVentaCabritoKg:t.precioVentaCabritoKg??3,precioVentaDescarteAdulto:t.precioVentaDescarteAdulto??50,monedaSimbolo:t.monedaSimbolo??"$",matingDistribution:t.matingDistribution},n=[],c=r*12,d=30.44;let i=[],o=[],m=[],M=0;const b=Math.round(e.diasGestacion/d),S=6,C=e.mortalidadCrias/100/12,h=e.mortalidadLevante/100/12,P=e.mortalidadCabras/100/12,yt=e.tasaReemplazo/100/12,jt=e.comprasVientresAnual/12,tt=new Set,et=[t.mesInicioMonta1,t.mesInicioMonta2,t.mesInicioMonta3,t.mesInicioMonta4].filter(s=>typeof s=="number"&&s>0);et.forEach(s=>tt.add(s));const _t=[.8,1.4,1.4,1.3,1.2,1,.9,.8,.7,.5],Ht=[.7,1.5,1.5,1.3,1,.6,.4],ot=e.diasLactanciaObjetivo>=305,nt=ot?_t:Ht,y=ot?1.4:1.5,wt=nt.length,j=e.litrosPromedioPorAnimal,it=e.litrosPicoPorAnimal,Rt=it>j&&j>0?it/j:y,Ot=y>1?(Rt-1)/(y-1):1,Gt=nt.map(s=>(s-1)*Ot+1);for(let s=0;s<c;s++){const l=n[s-1],st=Math.floor(s/12)+1,L=s%12+1,kt=`AÃ±o ${st} - Mes ${L}`,p=l?l.endCriaH:e.initialCriaH,g=l?l.endCriaM:e.initialCriaM,T=l?l.endLevanteTemprano:e.initialLevanteTemprano,x=l?l.endLevanteMedio:e.initialLevanteMedio,f=l?l.endLevanteTardio:e.initialLevanteTardio,u=l?l.endCabras:e.initialCabras,A=l?l.endPadres:e.initialPadres,Bt=p+g+T+x+f+u+A;let _=0;const at=[];i=i.filter(a=>a.monthEnd===s?(_+=a.size,at.push({id:a.id,size:a.size,monthEnd:s+S}),m.push({id:a.id,deliveries:a.size,startMonth:s}),!1):!0),o.push(...at),o=o.filter(a=>a.monthEnd>s);const rt=_*(e.porcentajeProlificidad/100),H=rt*.5,w=rt*.5;let R=0,v=0;if(tt.has(L)){const a=i.reduce((X,Z)=>X+Z.size,0),z=o.reduce((X,Z)=>X+Z.size,0),Q=Math.max(0,u-a-z),Qt=Math.max(0,f*(1-h)),At=et.indexOf(L),It=At!==-1&&e.matingDistribution?(e.matingDistribution[At]??100)/100:1,Xt=Q*It,Zt=Qt*It;R=Xt*(e.porcentajePrenez/100),v=Zt*(e.porcentajePrenez/100),R>0&&i.push({id:++M,size:R,monthEnd:s+b}),v>0&&i.push({id:++M,size:v,monthEnd:s+b})}const O=(p+H)*C,G=(g+w)*C,k=T*h,B=x*h,K=f*h,$=A*P,I=u*P,E=(u-I)*yt,ct=I+E,q=u>0?ct/u:0;i.forEach(a=>a.size*=1-q),o.forEach(a=>a.size*=1-q);const Kt=O+G+k+B+K+I+$,lt=Math.max(0,g+w-G),V=lt*(e.eliminacionCabritos/100),$t=V+E,U=jt,Y=0,qt=U+Y,dt=Math.max(0,p+H-O),mt=Math.max(0,T-k),ut=Math.max(0,x-B),Mt=Math.max(0,f-K),Ut=Math.max(0,Mt-v),F=dt/3,N=mt/3,W=ut/6,J=Ut/6,ht=Math.max(0,dt-F),vt=Math.max(0,lt-V),bt=Math.max(0,mt-N+F),ft=Math.max(0,ut-W+N),Ct=Math.max(0,Mt-v-J+U+W),Pt=Math.max(0,u-ct+J+v),Lt=Math.max(0,A-$+Y),Yt=ht+vt+bt+ft+Ct+Pt+Lt;let pt=0,gt=0;m.forEach(a=>a.deliveries*=1-q),m=m.filter(a=>{const z=s-a.startMonth;if(z<wt){const Q=Gt[z]||0;return pt+=a.deliveries*e.litrosPromedioPorAnimal*d*Q,gt+=a.deliveries,!0}return!1});const Tt=pt,Ft=gt,xt=Tt*e.precioLecheLitro,Nt=V*10*e.precioVentaCabritoKg,Wt=E*e.precioVentaDescarteAdulto,Jt=xt+Nt+Wt;n.push({monthIndex:s,year:st,month:L,periodLabel:kt,startCriaH:p,startCriaM:g,startLevanteTemprano:T,startLevanteMedio:x,startLevanteTardio:f,startCabras:u,startPadres:A,startTotal:Bt,partos:_,nacimientosH:H,nacimientosM:w,muertesCriaH:O,muertesCriaM:G,muertesLevanteTemprano:k,muertesLevanteMedio:B,muertesLevanteTardio:K,muertesCabras:I,muertesPadres:$,muertesTotales:Kt,ventasCabritos:V,ventasDescartes:E,ventasTotales:$t,comprasVientres:U,comprasPadres:Y,comprasTotales:qt,promocionCriaH:F,promocionLevanteTemprano:N,promocionLevanteMedio:W,promocionLevanteTardio:J,endCriaH:ht,endCriaM:vt,endLevanteTemprano:bt,endLevanteMedio:ft,endLevanteTardio:Ct,endCabras:Pt,endPadres:Lt,endTotal:Yt,litrosLeche:Tt,ingresosTotales:Jt,hembrasProduccion:Ft,ingresosLeche:xt})}return n},D=t=>!t||t.length===0?0:t.reduce((e,n)=>e+n,0)/t.length,Vt=t=>{if(!t||t.length<2)return 0;const r=D(t),e=t.reduce((n,c)=>n+Math.pow(c-r,2),0)/(t.length-1);return Math.sqrt(e)},zt=(t,r)=>{if(!t||t.length===0)return 0;const e=[];for(let n=0;n<r;n++){const c=t.slice(n*12,(n+1)*12);if(c.length===0)continue;const d=c.map(M=>M.litrosLeche),i=D(d),o=Vt(d),m=i>0?o/i*100:0;e.push(m)}return D(e)},Dt=t=>{if(t<=0)return[];const r=Array.from({length:t-1},()=>Math.random()*100);r.sort((o,m)=>o-m);const e=[0,...r,100],n=[];for(let o=0;o<t;o++)n.push(e[o+1]-e[o]);const c=n.map(o=>Math.round(o)),i=100-c.reduce((o,m)=>o+m,0);if(i!==0){const o=c.indexOf(Math.max(...c));c[o]+=i}return c},St=(t,r,e)=>{let n=1/0,c=[];const d=[t.mesInicioMonta1,t.mesInicioMonta2,t.mesInicioMonta3,t.mesInicioMonta4].filter(i=>typeof i=="number"&&i>0).length;if(d===0)throw new Error("No se definieron temporadas de monta.");d===1&&(e=1);for(let i=0;i<e;i++){let o;if(i===0){const S=Math.round(100/d);o=Array(d).fill(S);const C=o.reduce((h,P)=>h+P,0);o[0]+=100-C}else d===1?o=[100]:o=Dt(d);const m={...t,matingDistribution:o},M=Et(m,r),b=zt(M,r);b<n&&(n=b,c=o),i%Math.floor(e/10)===0&&self.postMessage({type:"progress",progress:i/e,bestCV:n})}self.postMessage({type:"result",progress:1,bestCV:n,bestDistribution:c})};self.onmessage=t=>{try{const{baseConfig:r,horizonInYears:e,totalSimulations:n}=t.data;St(r,e,n)}catch(r){self.postMessage({type:"error",error:r.message||"Error desconocido en el worker"})}}})();
