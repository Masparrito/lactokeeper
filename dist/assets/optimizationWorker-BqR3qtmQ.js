(function(){"use strict";const at=(t,i)=>{const e={initialCabras:t.initialCabras??0,initialLevanteTardio:t.initialLevanteTardio??0,initialLevanteMedio:t.initialLevanteMedio??0,initialLevanteTemprano:t.initialLevanteTemprano??0,initialCriaH:t.initialCriaH??0,initialCriaM:t.initialCriaM??0,initialPadres:t.initialPadres??1,comprasVientresAnual:t.comprasVientresAnual??0,mesInicioMonta1:t.mesInicioMonta1,mesInicioMonta2:t.mesInicioMonta2,mesInicioMonta3:t.mesInicioMonta3,mesInicioMonta4:t.mesInicioMonta4,duracionMontaDias:t.duracionMontaDias??45,diasGestacion:t.diasGestacion??150,litrosPromedioPorAnimal:t.litrosPromedioPorAnimal??1.8,diasLactanciaObjetivo:t.diasLactanciaObjetivo??305,litrosPicoPorAnimal:t.litrosPicoPorAnimal??((t.diasLactanciaObjetivo??305)>=305?(t.litrosPromedioPorAnimal??1.8)*1.4:(t.litrosPromedioPorAnimal??1.8)*1.5),porcentajePrenez:t.porcentajePrenez??85,porcentajeProlificidad:t.porcentajeProlificidad??120,mortalidadCrias:t.mortalidadCrias??5,mortalidadLevante:t.mortalidadLevante??3,mortalidadCabras:t.mortalidadCabras??3,tasaReemplazo:t.tasaReemplazo??20,eliminacionCabritos:t.eliminacionCabritos??100,precioLecheLitro:t.precioLecheLitro??.5,precioVentaCabritoKg:t.precioVentaCabritoKg??3,precioVentaDescarteAdulto:t.precioVentaDescarteAdulto??50,monedaSimbolo:t.monedaSimbolo??"$",matingDistribution:t.matingDistribution},o=[],m=i*12,l=30.44;let r=[],c=[],n=[],u=0;const b=Math.round(e.diasGestacion/l),M=6,h=e.mortalidadCrias/100/12,f=e.mortalidadLevante/100/12,p=e.mortalidadCabras/100/12,L=e.tasaReemplazo/100/12,_=e.comprasVientresAnual/12,g=new Set,T=[t.mesInicioMonta1,t.mesInicioMonta2,t.mesInicioMonta3,t.mesInicioMonta4].filter(s=>typeof s=="number"&&s>0);T.forEach(s=>g.add(s));const H=[.8,1.4,1.4,1.3,1.2,1,.9,.8,.7,.5],wt=[.7,1.5,1.5,1.3,1,.6,.4],ct=e.diasLactanciaObjetivo>=305,lt=ct?H:wt,R=ct?1.4:1.5,_t=lt.length,G=e.litrosPromedioPorAnimal,dt=e.litrosPicoPorAnimal,Ht=dt>G&&G>0?dt/G:R,Rt=R>1?(Ht-1)/(R-1):1,Gt=lt.map(s=>(s-1)*Rt+1);for(let s=0;s<m;s++){const d=o[s-1],mt=Math.floor(s/12)+1,x=s%12+1,Ot=`A침o ${mt} - Mes ${x}`,D=d?d.endCriaH:e.initialCriaH,E=d?d.endCriaM:e.initialCriaM,y=d?d.endLevanteTemprano:e.initialLevanteTemprano,A=d?d.endLevanteMedio:e.initialLevanteMedio,P=d?d.endLevanteTardio:e.initialLevanteTardio,v=d?d.endCabras:e.initialCabras,V=d?d.endPadres:e.initialPadres,kt=D+E+y+A+P+v+V;let O=0;const ut=[];r=r.filter(a=>a.monthEnd===s?(O+=a.size,ut.push({id:a.id,size:a.size,monthEnd:s+M}),n.push({id:a.id,deliveries:a.size,startMonth:s}),!1):!0),c.push(...ut),c=c.filter(a=>a.monthEnd>s);const Mt=O*(e.porcentajeProlificidad/100),k=Mt*.5,B=Mt*.5;let K=0,C=0;if(g.has(x)){const a=r.reduce((it,st)=>it+st.size,0),j=c.reduce((it,st)=>it+st.size,0),ot=Math.max(0,v-a-j),Qt=Math.max(0,P*(1-f)),nt=T.indexOf(x),Xt=nt!==-1&&e.matingDistribution&&e.matingDistribution[nt]!==void 0?e.matingDistribution[nt]:1/0,Yt=Math.min(ot,Xt),Zt=Qt;K=Yt*(e.porcentajePrenez/100),C=Zt*(e.porcentajePrenez/100),K>0&&r.push({id:++u,size:K,monthEnd:s+b}),C>0&&r.push({id:++u,size:C,monthEnd:s+b})}const $=(D+k)*h,q=(E+B)*h,N=y*f,U=A*f,F=P*f,W=V*p,I=v*p,S=(v-I)*L,ht=I+S,J=v>0?ht/v:0;r.forEach(a=>a.size*=1-J),c.forEach(a=>a.size*=1-J);const Bt=$+q+N+U+F+I+W,vt=Math.max(0,E+B-q),z=vt*(e.eliminacionCabritos/100),Kt=z+S,Q=_,X=0,$t=Q+X,bt=Math.max(0,D+k-$),ft=Math.max(0,y-N),Ct=Math.max(0,A-U),pt=Math.max(0,P-F),qt=Math.max(0,pt-C),Y=bt/3,Z=ft/3,tt=Ct/6,et=qt/6,Pt=Math.max(0,bt-Y),Lt=Math.max(0,vt-z),gt=Math.max(0,ft-Z+Y),Tt=Math.max(0,Ct-tt+Z),xt=Math.max(0,pt-C-et+Q+tt),Dt=Math.max(0,v-ht+et+C),Et=Math.max(0,V-W+X),Nt=Pt+Lt+gt+Tt+xt+Dt+Et;let yt=0,At=0;n.forEach(a=>a.deliveries*=1-J),n=n.filter(a=>{const j=s-a.startMonth;if(j<_t){const ot=Gt[j]||0;return yt+=a.deliveries*e.litrosPromedioPorAnimal*l*ot,At+=a.deliveries,!0}return!1});const Vt=yt,Ut=At,It=Vt*e.precioLecheLitro,Ft=z*10*e.precioVentaCabritoKg,Wt=S*e.precioVentaDescarteAdulto,Jt=It+Ft+Wt;o.push({monthIndex:s,year:mt,month:x,periodLabel:Ot,startCriaH:D,startCriaM:E,startLevanteTemprano:y,startLevanteMedio:A,startLevanteTardio:P,startCabras:v,startPadres:V,startTotal:kt,partos:O,nacimientosH:k,nacimientosM:B,muertesCriaH:$,muertesCriaM:q,muertesLevanteTemprano:N,muertesLevanteMedio:U,muertesLevanteTardio:F,muertesCabras:I,muertesPadres:W,muertesTotales:Bt,ventasCabritos:z,ventasDescartes:S,ventasTotales:Kt,comprasVientres:Q,comprasPadres:X,comprasTotales:$t,promocionCriaH:Y,promocionLevanteTemprano:Z,promocionLevanteMedio:tt,promocionLevanteTardio:et,endCriaH:Pt,endCriaM:Lt,endLevanteTemprano:gt,endLevanteMedio:Tt,endLevanteTardio:xt,endCabras:Dt,endPadres:Et,endTotal:Nt,litrosLeche:Vt,ingresosTotales:Jt,hembrasProduccion:Ut,ingresosLeche:It})}return o},w=t=>!t||t.length===0?0:t.reduce((e,o)=>e+o,0)/t.length,St=t=>{if(!t||t.length<2)return 0;const i=w(t),e=t.reduce((o,m)=>o+Math.pow(m-i,2),0)/(t.length-1);return Math.sqrt(e)},rt=(t,i)=>{if(!t||t.length===0)return 0;const e=[];for(let o=0;o<i;o++){const m=t.slice(o*12,(o+1)*12);if(m.length===0)continue;const l=m.map(u=>u.litrosLeche),r=w(l),c=St(l),n=r>0?c/r*100:0;e.push(n)}return w(e)},zt=(t,i)=>{if(t<=0)return[];if(i===0)return Array(t).fill(0);const e=Array.from({length:t-1},()=>Math.random()*i);e.sort((n,u)=>n-u);const o=[0,...e,i],m=[];for(let n=0;n<t;n++)m.push(o[n+1]-o[n]);const l=m.map(n=>Math.round(n)),r=l.reduce((n,u)=>n+u,0),c=i-r;if(c!==0){const n=l.indexOf(Math.max(...l));l[n]+=c}return l},jt=(t,i,e)=>{const o=[t.mesInicioMonta1,t.mesInicioMonta2,t.mesInicioMonta3,t.mesInicioMonta4].filter(M=>typeof M=="number"&&M>0).length;if(o===0)throw new Error("No se definieron temporadas de monta.");const m=t.initialCabras??0,l=at(t,i),r=rt(l,i);let c=r,n,u=l;self.postMessage({type:"progress",progress:0,baseCV:r,bestCV:c}),o===1&&(e=1);const b=e-1;for(let M=0;M<b;M++){let h;if(M===0){const _=Math.round(m/o);h=Array(o).fill(_);const g=h.reduce((T,H)=>T+H,0);h[0]+=m-g}else h=zt(o,m);const f={...t,matingDistribution:h},p=at(f,i),L=rt(p,i);L<c&&(c=L,n=h,u=p),M%Math.floor(b/20)===0&&self.postMessage({type:"progress",progress:M/b,baseCV:r,bestCV:c})}self.postMessage({type:"result",progress:1,baseCV:r,bestCV:c,bestDistribution:n,baseMonthlyData:l,bestMonthlyData:u})};self.onmessage=t=>{try{const{baseConfig:i,horizonInYears:e,totalSimulations:o}=t.data;if(!i)throw new Error("No se proporcion칩 configuraci칩n base al worker.");jt(i,e,o)}catch(i){self.postMessage({type:"error",error:i.message||"Error desconocido en el worker de optimizaci칩n"})}}})();
